#!/bin/bash
# Auto-generated build script for Verilog simulation
# Generated by CentralizedAgentFramework ScriptManager

# è®¾ç½®é¢œè‰²è¾“å‡º
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# é…ç½®å˜é‡
VERILOG_FILES="simple_adder.v"
TESTBENCH_FILES="simple_adder_tb.v"
TARGET="simple_adder_sim"

# å‡½æ•°å®šä¹‰
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# æ£€æŸ¥æ–‡ä»¶å­˜åœ¨æ€§
check_files() {
    log_info "æ£€æŸ¥æºæ–‡ä»¶..."
    local missing_files=0
    
    for file in $VERILOG_FILES $TESTBENCH_FILES; do
        if [ -f "$file" ]; then
            log_success "âœ… $file"
        else
            log_error "âŒ $file (æ–‡ä»¶ä¸å­˜åœ¨)"
            missing_files=$((missing_files + 1))
        fi
    done
    
    if [ $missing_files -gt 0 ]; then
        log_error "å‘ç° $missing_files ä¸ªç¼ºå¤±æ–‡ä»¶ï¼Œæ— æ³•ç»§ç»­"
        exit 1
    fi
}

# ç¼–è¯‘åŠŸèƒ½
compile() {
    log_info "ğŸ”¨ å¼€å§‹ç¼–è¯‘..."
    
    # ä½¿ç”¨iverilogç¼–è¯‘
    if iverilog -o "$TARGET" $VERILOG_FILES $TESTBENCH_FILES; then
        log_success "âœ… ç¼–è¯‘æˆåŠŸ: $TARGET"
        return 0
    else
        log_error "âŒ ç¼–è¯‘å¤±è´¥"
        return 1
    fi
}

# ä»¿çœŸåŠŸèƒ½
simulate() {
    log_info "â–¶ï¸ å¼€å§‹ä»¿çœŸ..."
    
    if [ ! -f "$TARGET" ]; then
        log_error "å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨: $TARGET"
        return 1
    fi
    
    # è¿è¡Œä»¿çœŸ
    if vvp "$TARGET"; then
        log_success "âœ… ä»¿çœŸå®Œæˆ"
        
        # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†VCDæ–‡ä»¶
        if [ -f "${TARGET}.vcd" ]; then
            log_success "ğŸ“Š æ³¢å½¢æ–‡ä»¶å·²ç”Ÿæˆ: ${TARGET}.vcd"
        fi
        
        return 0
    else
        log_error "âŒ ä»¿çœŸå¤±è´¥"
        return 1
    fi
}

# æ¸…ç†åŠŸèƒ½
clean() {
    log_info "ğŸ§¹ æ¸…ç†æ–‡ä»¶..."
    rm -f "$TARGET" *.vcd *.lxt2
    log_success "âœ… æ¸…ç†å®Œæˆ"
}

# ä¸»é€»è¾‘
case "$1" in
    "compile")
        check_files
        compile
        ;;
    "simulate")
        if [ ! -f "$TARGET" ]; then
            log_warning "å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå…ˆè¿›è¡Œç¼–è¯‘..."
            check_files
            compile || exit 1
        fi
        simulate
        ;;
    "clean")
        clean
        ;;
    "all"|"")
        check_files
        compile || exit 1
        simulate
        ;;
    "help")
        echo "ç”¨æ³•: $0 [compile|simulate|clean|all|help]"
        echo "  compile  - ä»…ç¼–è¯‘"
        echo "  simulate - ä»…ä»¿çœŸï¼ˆå¦‚éœ€è¦ä¼šå…ˆç¼–è¯‘ï¼‰"
        echo "  clean    - æ¸…ç†ç”Ÿæˆçš„æ–‡ä»¶"
        echo "  all      - ç¼–è¯‘å¹¶ä»¿çœŸï¼ˆé»˜è®¤ï¼‰"
        echo "  help     - æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"
        ;;
    *)
        log_error "æœªçŸ¥å‚æ•°: $1"
        echo "ä½¿ç”¨ '$0 help' æŸ¥çœ‹å¸®åŠ©"
        exit 1
        ;;
esac
