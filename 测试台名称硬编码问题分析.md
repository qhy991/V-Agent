# 测试台名称硬编码问题分析

## 🔍 问题发现

通过分析 `alu_test_utf8-2.txt` 文件，我发现了测试台名称被硬编码的问题：

### 问题现象
- ALU实验生成了错误的测试台：`testbench_simple_adder.v` 而不是 `testbench_alu_32bit.v`
- 测试台内容针对 `simple_adder` 模块，与实际的 `alu_32bit` 模块不匹配

### 根本原因
1. **系统提示中的硬编码示例**：代码审查智能体的系统提示中包含了 `"simple_adder"` 作为示例
2. **LLM复制示例**：LLM在生成工具调用时直接复制了示例中的模块名
3. **缺乏动态验证**：没有验证提供的模块名与实际代码中的模块名是否匹配

## 📍 问题位置

### 1. 代码审查智能体系统提示
**文件**: `agents/enhanced_real_code_reviewer.py`
**位置**: `_build_enhanced_system_prompt()` 方法

```python
# 硬编码的示例
"module_name": "simple_adder",
"code": "module simple_adder(...); endmodule",
"verilog_code": "module simple_adder(...); endmodule"
```

### 2. Verilog智能体系统提示
**文件**: `agents/enhanced_real_verilog_agent.py`
**位置**: `_build_enhanced_system_prompt()` 方法

```python
# 硬编码的示例
"module_name": "simple_adder",
"requirements": "设计一个8位加法器"
```

## 🔧 修复方案

### 1. 移除硬编码示例
将系统提示中的硬编码示例替换为通用示例：
- `"simple_adder"` → `"target_module"`
- `"设计一个8位加法器"` → `"设计目标模块"`

### 2. 添加动态模块名提取
实现从Verilog代码中自动提取模块名的功能：

```python
def _extract_module_name_from_code(self, verilog_code: str) -> str:
    """从Verilog代码中提取模块名"""
    import re
    
    # 匹配module声明
    module_pattern = r'module\s+(\w+)\s*\('
    match = re.search(module_pattern, verilog_code, re.IGNORECASE)
    
    if match:
        return match.group(1)
    
    return "unknown_module"
```

### 3. 验证和修复模块名
在测试台生成时验证模块名：

```python
def _validate_and_fix_module_name(self, provided_name: str, verilog_code: str) -> str:
    """验证并修复模块名"""
    extracted_name = self._extract_module_name_from_code(verilog_code)
    
    if provided_name and provided_name != extracted_name:
        self.logger.warning(f"⚠️ 模块名不匹配: 提供={provided_name}, 提取={extracted_name}")
        return extracted_name
    
    return provided_name or extracted_name
```

## 📋 修复文件

### 1. 修复脚本
- **文件**: `fix_testbench_naming.py`
- **功能**: 自动化修复所有硬编码问题

### 2. 测试脚本
- **文件**: `test_testbench_fix.py`
- **功能**: 验证修复效果

## 🎯 预期效果

修复后，系统将能够：
1. **正确识别模块名**：从Verilog代码中自动提取正确的模块名
2. **生成正确的测试台**：使用正确的模块名生成测试台文件
3. **避免硬编码依赖**：不再依赖固定的示例模块名

## 🚀 使用方法

1. **运行修复脚本**：
   ```bash
   python fix_testbench_naming.py
   ```

2. **验证修复效果**：
   ```bash
   python test_testbench_fix.py
   ```

3. **重新运行ALU实验**：
   ```bash
   python unified_tdd_test.py --design alu
   ```

## 📊 影响范围

这个修复将解决：
- ✅ ALU实验的测试台生成问题
- ✅ 其他模块的测试台生成问题
- ✅ 智能体选择逻辑的改进
- ✅ 整体系统的稳定性提升

## 🔍 验证方法

修复后可以通过以下方式验证：
1. 检查生成的测试台文件名是否正确
2. 验证测试台内容是否匹配目标模块
3. 确认仿真能够正常运行
4. 测试不同模块名的处理情况 