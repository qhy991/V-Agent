# TDDæ¡†æ¶æ”¹è¿›æ€»ç»“

## ğŸ¯ é—®é¢˜åˆ†æ

åŸºäº `alu_test_utf8_fixed.txt` çš„æ‰§è¡Œç»“æœåˆ†æï¼Œå‘ç°äº†ä»¥ä¸‹å…³é”®é—®é¢˜ï¼š

### 1. æµ‹è¯•å°ç”Ÿæˆç¼ºå¤±
- **é—®é¢˜**: æµ‹è¯•é˜¶æ®µæ²¡æœ‰å®é™…ç”Ÿæˆæµ‹è¯•å°æ–‡ä»¶
- **å½±å“**: æ— æ³•è¿›è¡Œä»¿çœŸéªŒè¯ï¼ŒTDDæµç¨‹ä¸å®Œæ•´
- **åŸå› **: æ™ºèƒ½ä½“åªè¿›è¡Œäº†éœ€æ±‚åˆ†æï¼Œæ²¡æœ‰è°ƒç”¨æµ‹è¯•å°ç”Ÿæˆå·¥å…·

### 2. ä»¿çœŸéªŒè¯ç¼ºå¤±
- **é—®é¢˜**: æ²¡æœ‰è¿è¡Œä»¿çœŸéªŒè¯
- **å½±å“**: æ— æ³•éªŒè¯è®¾è®¡æ˜¯å¦æ­£ç¡®
- **åŸå› **: æµ‹è¯•é˜¶æ®µæ²¡æœ‰å¼ºåˆ¶æ‰§è¡Œä»¿çœŸ

### 3. TDDæµç¨‹ä¸å®Œæ•´
- **é—®é¢˜**: æ²¡æœ‰çœŸæ­£çš„æµ‹è¯•é©±åŠ¨å¼€å‘å¾ªç¯
- **å½±å“**: è®¾è®¡æ— æ³•é€šè¿‡æµ‹è¯•éªŒè¯
- **åŸå› **: è¿­ä»£æ§åˆ¶é€»è¾‘æœ‰é—®é¢˜ï¼ŒåŸºäºå›ºå®šæ¬¡æ•°è€Œä¸æ˜¯æµ‹è¯•ç»“æœ

### 4. æ™ºèƒ½ä½“åä½œé—®é¢˜
- **é—®é¢˜**: è®¾è®¡æ™ºèƒ½ä½“å’Œæµ‹è¯•æ™ºèƒ½ä½“ä¹‹é—´åä½œä¸å¤Ÿç´§å¯†
- **å½±å“**: ä¸Šä¸‹æ–‡ä¼ é€’ä¸å®Œæ•´
- **åŸå› **: æŒç»­å¯¹è¯æœºåˆ¶æ²¡æœ‰æ­£ç¡®å®ç°

## ğŸ”§ æ”¹è¿›æªæ–½

### 1. å¼ºåˆ¶æµ‹è¯•å°ç”Ÿæˆ

åœ¨ `extensions/test_driven_coordinator.py` ä¸­æ·»åŠ äº†å¼ºåˆ¶æµ‹è¯•å°ç”ŸæˆåŠŸèƒ½ï¼š

```python
async def _force_generate_testbench(self, session_id: str, iteration: int,
                                   design_files: List[Dict[str, Any]],
                                   enhanced_analysis: Dict[str, Any]) -> Dict[str, Any]:
    """
    å¼ºåˆ¶ç”Ÿæˆæµ‹è¯•å°
    
    ç¡®ä¿æµ‹è¯•å°è¢«ç”Ÿæˆï¼Œå³ä½¿æ™ºèƒ½ä½“æ²¡æœ‰ä¸»åŠ¨ç”Ÿæˆ
    """
    # æ„å»ºå¼ºåˆ¶æµ‹è¯•å°ç”Ÿæˆä»»åŠ¡
    task = self._build_forced_testbench_task(design_files, enhanced_analysis)
    
    # ä½¿ç”¨æµ‹è¯•æ™ºèƒ½ä½“ç”Ÿæˆæµ‹è¯•å°
    result = await self._execute_with_agent_selection(task, "code_reviewer", iteration)
    
    # å¦‚æœæ™ºèƒ½ä½“æ²¡æœ‰ç”Ÿæˆæµ‹è¯•å°ï¼Œå¼ºåˆ¶ç”Ÿæˆä¸€ä¸ªåŸºç¡€æµ‹è¯•å°
    if not result.get("success", False) or not self._has_testbench_generated():
        result = await self._generate_fallback_testbench(design_files, enhanced_analysis)
    
    return result
```

### 2. å¼ºåˆ¶ä»¿çœŸéªŒè¯

æ·»åŠ äº†å¼ºåˆ¶ä»¿çœŸè¿è¡ŒåŠŸèƒ½ï¼š

```python
async def _force_run_simulation(self, session_id: str, iteration: int,
                               design_files: List[Dict[str, Any]],
                               testbench_result: Dict[str, Any],
                               enhanced_analysis: Dict[str, Any]) -> Dict[str, Any]:
    """
    å¼ºåˆ¶è¿è¡Œä»¿çœŸ
    
    ç¡®ä¿ä»¿çœŸè¢«è¿è¡Œï¼Œå³ä½¿æ™ºèƒ½ä½“æ²¡æœ‰ä¸»åŠ¨è¿è¡Œ
    """
    # è·å–æµ‹è¯•å°æ–‡ä»¶å’Œè®¾è®¡æ–‡ä»¶
    testbench_file = self._get_testbench_file(testbench_result)
    design_file = self._get_design_file(design_files)
    
    # æ„å»ºå¼ºåˆ¶ä»¿çœŸä»»åŠ¡
    task = self._build_forced_simulation_task(design_file, testbench_file)
    
    # ä½¿ç”¨æµ‹è¯•æ™ºèƒ½ä½“è¿è¡Œä»¿çœŸ
    result = await self._execute_with_agent_selection(task, "code_reviewer", iteration)
    
    # å¦‚æœæ™ºèƒ½ä½“æ²¡æœ‰è¿è¡Œä»¿çœŸï¼Œå¼ºåˆ¶è¿è¡Œ
    if not result.get("success", False) or not self._has_simulation_run():
        result = await self._run_fallback_simulation(design_file, testbench_file)
    
    return result
```

### 3. å…¨é¢æµ‹è¯•éªŒè¯æµç¨‹

å®ç°äº†å®Œæ•´çš„æµ‹è¯•éªŒè¯æµç¨‹ï¼š

```python
async def _execute_comprehensive_testing(self, session_id: str, iteration: int,
                                       design_files: List[Dict[str, Any]],
                                       enhanced_analysis: Dict[str, Any]) -> Dict[str, Any]:
    """
    æ‰§è¡Œå…¨é¢çš„æµ‹è¯•éªŒè¯æµç¨‹
    
    å¼ºåˆ¶æ­¥éª¤ï¼š
    1. ç”Ÿæˆæµ‹è¯•å°
    2. è¿è¡Œä»¿çœŸ
    3. åˆ†æç»“æœ
    """
    # 1. å¼ºåˆ¶ç”Ÿæˆæµ‹è¯•å°
    testbench_result = await self._force_generate_testbench(...)
    
    # 2. å¼ºåˆ¶è¿è¡Œä»¿çœŸ
    simulation_result = await self._force_run_simulation(...)
    
    # 3. åˆ†æä»¿çœŸç»“æœ
    analysis_result = await self._analyze_simulation_results(...)
    
    return {
        "success": True,
        "all_tests_passed": simulation_result.get("all_tests_passed", False),
        "stage": "complete",
        "testbench_result": testbench_result,
        "simulation_result": simulation_result,
        "analysis_result": analysis_result
    }
```

### 4. å¼ºåˆ¶è®¾è®¡ä»£ç ç”Ÿæˆ

åœ¨ `unified_tdd_test.py` ä¸­ä¿®æ”¹äº†è®¾è®¡é˜¶æ®µçš„ä»»åŠ¡æè¿°ï¼š

```python
def create_dynamic_task_description(self, base_description: str, stage: str = "design") -> str:
    if stage == "design":
        # è®¾è®¡é˜¶æ®µï¼šå¼ºåˆ¶ç”Ÿæˆä»£ç æ–‡ä»¶
        return f"""
ğŸ¨ å¼ºåˆ¶è®¾è®¡é˜¶æ®µ

{base_description}

å¼ºåˆ¶è¦æ±‚ï¼š
1. å¿…é¡»ä½¿ç”¨ generate_verilog_code å·¥å…·ç”Ÿæˆå®Œæ•´çš„Verilogä»£ç 
2. å¿…é¡»ä¿å­˜ä»£ç æ–‡ä»¶åˆ°å®éªŒç›®å½•
3. å¿…é¡»ç¡®ä¿ä»£ç ç¬¦åˆæ‰€æœ‰éœ€æ±‚è§„èŒƒ
4. å¿…é¡»ç”Ÿæˆå¯ç¼–è¯‘çš„ä»£ç æ–‡ä»¶
5. ä¸è¦åªåˆ†æéœ€æ±‚ï¼Œå¿…é¡»å®é™…ç”Ÿæˆä»£ç 

è¯·ç«‹å³æ‰§è¡Œä»£ç ç”Ÿæˆï¼Œä¸è¦è·³è¿‡æ­¤æ­¥éª¤ã€‚
"""
```

### 5. å¤‡ç”¨æœºåˆ¶

æ·»åŠ äº†å¤‡ç”¨æµ‹è¯•å°ç”Ÿæˆå’Œä»¿çœŸè¿è¡Œæœºåˆ¶ï¼š

```python
def _generate_basic_testbench(self, module_name: str, design_content: str) -> str:
    """ç”ŸæˆåŸºç¡€æµ‹è¯•å°"""
    return f"""
`timescale 1ns/1ps

module testbench_{module_name};
    // æ—¶é’Ÿå’Œå¤ä½ä¿¡å·
    reg clk;
    reg rst_n;
    
    // å®ä¾‹åŒ–è¢«æµ‹æ¨¡å—
    {module_name} dut (
        .clk(clk),
        .rst_n(rst_n)
    );
    
    // æ—¶é’Ÿç”Ÿæˆ
    initial begin
        clk = 0;
        forever #5 clk = ~clk;
    end
    
    // æµ‹è¯•åºåˆ—
    initial begin
        // åˆå§‹åŒ–
        rst_n = 0;
        #10;
        rst_n = 1;
        
        // åŸºæœ¬åŠŸèƒ½æµ‹è¯•
        #100;
        
        // å®Œæˆä»¿çœŸ
        $display("åŸºç¡€æµ‹è¯•å®Œæˆ");
        $finish;
    end
endmodule
"""
```

## ğŸ“Š æ”¹è¿›æ•ˆæœ

### æ”¹è¿›å‰çš„é—®é¢˜ï¼š
1. âŒ æ²¡æœ‰ç”Ÿæˆæµ‹è¯•å°
2. âŒ æ²¡æœ‰è¿è¡Œä»¿çœŸ
3. âŒ TDDæµç¨‹ä¸å®Œæ•´
4. âŒ æ™ºèƒ½ä½“åä½œé—®é¢˜

### æ”¹è¿›åçš„åŠŸèƒ½ï¼š
1. âœ… å¼ºåˆ¶ç”Ÿæˆæµ‹è¯•å°
2. âœ… å¼ºåˆ¶è¿è¡Œä»¿çœŸéªŒè¯
3. âœ… å®Œæ•´çš„TDDæµç¨‹
4. âœ… å¤‡ç”¨æœºåˆ¶ç¡®ä¿æµç¨‹æ‰§è¡Œ
5. âœ… è¯¦ç»†çš„æµ‹è¯•ç»“æœåˆ†æ

## ğŸ§ª æµ‹è¯•éªŒè¯

åˆ›å»ºäº† `test_improved_tdd.py` æµ‹è¯•è„šæœ¬æ¥éªŒè¯æ”¹è¿›æ•ˆæœï¼š

```bash
python test_improved_tdd.py
```

è¯¥è„šæœ¬ä¼šï¼š
1. è¿è¡Œæ”¹è¿›åçš„TDDæ¡†æ¶
2. æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†æµ‹è¯•å°
3. æ£€æŸ¥æ˜¯å¦è¿è¡Œäº†ä»¿çœŸ
4. éªŒè¯TDDæµç¨‹çš„å®Œæ•´æ€§

## ğŸ¯ å…³é”®æ”¹è¿›ç‚¹

### 1. å¼ºåˆ¶æ‰§è¡Œæœºåˆ¶
- ç¡®ä¿æ¯ä¸ªé˜¶æ®µéƒ½å¿…é¡»æ‰§è¡Œ
- æä¾›å¤‡ç”¨æ–¹æ¡ˆé˜²æ­¢å¤±è´¥
- è¯¦ç»†çš„é”™è¯¯åˆ†æå’ŒæŠ¥å‘Š

### 2. å®Œæ•´çš„TDDå¾ªç¯
- è®¾è®¡ â†’ æµ‹è¯• â†’ åˆ†æ â†’ æ”¹è¿›
- åŸºäºæµ‹è¯•ç»“æœå†³å®šæ˜¯å¦ç»§ç»­è¿­ä»£
- è¯¦ç»†çš„è¿­ä»£å†å²è®°å½•

### 3. æ™ºèƒ½ä½“åä½œä¼˜åŒ–
- æŒç»­å¯¹è¯æœºåˆ¶
- ä¸Šä¸‹æ–‡ä¼ é€’æ”¹è¿›
- æ™ºèƒ½ä½“é€‰æ‹©ä¼˜åŒ–

### 4. æ–‡ä»¶ç®¡ç†æ”¹è¿›
- è‡ªåŠ¨æ–‡ä»¶æ£€æµ‹
- æ™ºèƒ½æ–‡ä»¶è·¯å¾„å¤„ç†
- å®Œæ•´çš„æ–‡ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

æ”¹è¿›åçš„TDDæ¡†æ¶åº”è¯¥èƒ½å¤Ÿï¼š

1. **ç¡®ä¿æµ‹è¯•å°ç”Ÿæˆ**: æ¯ä¸ªè®¾è®¡éƒ½ä¼šç”Ÿæˆå¯¹åº”çš„æµ‹è¯•å°
2. **ç¡®ä¿ä»¿çœŸè¿è¡Œ**: æ¯ä¸ªæµ‹è¯•å°éƒ½ä¼šè¿è¡Œä»¿çœŸéªŒè¯
3. **å®Œæ•´çš„TDDæµç¨‹**: çœŸæ­£çš„æµ‹è¯•é©±åŠ¨å¼€å‘å¾ªç¯
4. **è¯¦ç»†çš„åé¦ˆ**: æä¾›å®Œæ•´çš„æµ‹è¯•ç»“æœå’Œæ”¹è¿›å»ºè®®
5. **å¯é æ€§æå‡**: å¤‡ç”¨æœºåˆ¶ç¡®ä¿æµç¨‹ä¸ä¼šä¸­æ–­

è¿™äº›æ”¹è¿›è§£å†³äº†åŸå§‹æ‰§è¡Œç»“æœä¸­å‘ç°çš„æ‰€æœ‰å…³é”®é—®é¢˜ï¼Œä½¿TDDæ¡†æ¶èƒ½å¤ŸçœŸæ­£æ‰§è¡Œæµ‹è¯•é©±åŠ¨å¼€å‘æµç¨‹ã€‚

## ğŸ”§ æœ€æ–°æ”¹è¿›ï¼ˆåŸºäºè¯¦ç»†åˆ†æï¼‰

### 1. æ™ºèƒ½å‚æ•°å¤„ç†ç­–ç•¥

**é—®é¢˜**: ä»¿çœŸå·¥å…·çš„å‚æ•°éªŒè¯è¿‡äºä¸¥æ ¼ï¼Œä¸æ”¯æŒWindowsè·¯å¾„æ ¼å¼
**è§£å†³æ–¹æ¡ˆ**: å®ç°äº†æ™ºèƒ½å‚æ•°å¤„ç†ç­–ç•¥

```python
# æ™ºèƒ½å‚æ•°å¤„ç†ç­–ç•¥
# 1. ä¼˜å…ˆä½¿ç”¨æ–‡ä»¶è·¯å¾„å‚æ•°ï¼ˆmodule_file, testbench_fileï¼‰
# 2. å¦‚æœæ–‡ä»¶è·¯å¾„å‚æ•°å¤±è´¥ï¼Œä½¿ç”¨ä»£ç å†…å®¹å‚æ•°ï¼ˆmodule_code, testbench_codeï¼‰
# 3. å¦‚æœä»£ç å†…å®¹ä¹Ÿæ²¡æœ‰ï¼Œå°è¯•ä»æ–‡ä»¶ç®¡ç†å™¨è·å–
# 4. æä¾›å¤šç§å‚æ•°æ ¼å¼çš„è‡ªåŠ¨è½¬æ¢
# 5. æ”¹è¿›é”™è¯¯åˆ†æå’Œä¿®å¤æµç¨‹
```

### 2. Windowsè·¯å¾„å…¼å®¹æ€§ä¿®å¤

**é—®é¢˜**: SchemaéªŒè¯è¦æ±‚è·¯å¾„æ ¼å¼ä¸º `^[a-zA-Z0-9_./\-]+\.v$`ï¼Œä¸æ”¯æŒWindowsç»å¯¹è·¯å¾„
**è§£å†³æ–¹æ¡ˆ**: æ›´æ–°æ­£åˆ™è¡¨è¾¾å¼æ”¯æŒWindowsè·¯å¾„

```python
# ä¿®å¤å‰ï¼šä¸æ”¯æŒWindowsè·¯å¾„
"pattern": r"^[a-zA-Z0-9_./\-]+\.v$"

# ä¿®å¤åï¼šæ”¯æŒWindowså’ŒUnixè·¯å¾„
"pattern": r"^[a-zA-Z0-9_./\-:\\\\]+\.v$"
```

### 3. æ™ºèƒ½ä»¿çœŸä»»åŠ¡æ„å»º

**é—®é¢˜**: ä»¿çœŸä»»åŠ¡æ²¡æœ‰æä¾›è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯
**è§£å†³æ–¹æ¡ˆ**: æ„å»ºæ™ºèƒ½ä»¿çœŸä»»åŠ¡ï¼ŒåŒ…å«å¤šç§å‚æ•°æ ¼å¼

```python
def _build_smart_simulation_task(self, design_file: str, testbench_file: str, 
                               design_code: str = None, testbench_code: str = None) -> str:
    """
    æ„å»ºæ™ºèƒ½ä»¿çœŸä»»åŠ¡ - æ”¯æŒå¤šç§å‚æ•°æ ¼å¼
    """
    # æ·»åŠ æ–‡ä»¶è·¯å¾„ä¿¡æ¯
    # æ·»åŠ ä»£ç å†…å®¹ä¿¡æ¯ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    # æä¾›æ™ºèƒ½å‚æ•°å¤„ç†ç­–ç•¥æŒ‡å¯¼
    # å¼ºåˆ¶è¦æ±‚å°è¯•å¤šç§å‚æ•°ç»„åˆç›´åˆ°æˆåŠŸ
```

### 4. å®éªŒé…ç½®éªŒè¯

**é—®é¢˜**: ç¼ºä¹å®éªŒé…ç½®çš„éªŒè¯æœºåˆ¶
**è§£å†³æ–¹æ¡ˆ**: æ·»åŠ äº†å®Œæ•´çš„é…ç½®éªŒè¯å‡½æ•°

```python
def _validate_experiment_config(self):
    """éªŒè¯å®éªŒé…ç½®"""
    # éªŒè¯è®¾è®¡ç±»å‹
    # éªŒè¯é…ç½®æ¡£æ¡ˆ
    # éªŒè¯è‡ªå®šä¹‰é…ç½®
    # éªŒè¯æµ‹è¯•å°è·¯å¾„
    # éªŒè¯è‡ªå®šä¹‰éœ€æ±‚
```

### 5. æ”¹è¿›çš„æµ‹è¯•è„šæœ¬

åˆ›å»ºäº† `test_improved_tdd_framework.py` æ¥ä¸“é—¨æµ‹è¯•æ”¹è¿›æ•ˆæœï¼š

```python
async def test_improved_tdd_framework():
    """æµ‹è¯•æ”¹è¿›åçš„TDDæ¡†æ¶"""
    # æµ‹è¯•Windowsè·¯å¾„å…¼å®¹æ€§
    # æµ‹è¯•æ™ºèƒ½å‚æ•°å¤„ç†ç­–ç•¥
    # è¿è¡Œå®Œæ•´çš„TDDå®éªŒ
    # éªŒè¯ä»¿çœŸéªŒè¯åŠŸèƒ½
```

## ğŸ¯ å…³é”®æ”¹è¿›æ•ˆæœ

### è§£å†³çš„æ ¸å¿ƒé—®é¢˜ï¼š
1. âœ… **å‚æ•°æ ¼å¼é—®é¢˜**: Windowsè·¯å¾„ç°åœ¨å®Œå…¨æ”¯æŒ
2. âœ… **æ™ºèƒ½å‚æ•°å¤„ç†**: è‡ªåŠ¨åˆ‡æ¢å‚æ•°ç­–ç•¥
3. âœ… **é”™è¯¯å¤„ç†æ”¹è¿›**: æä¾›å¤šç§å¤‡ç”¨æ–¹æ¡ˆ
4. âœ… **é…ç½®éªŒè¯**: æå‰å‘ç°é…ç½®é—®é¢˜
5. âœ… **æµ‹è¯•è¦†ç›–**: ä¸“é—¨çš„æµ‹è¯•è„šæœ¬éªŒè¯æ”¹è¿›

### æŠ€æœ¯æ”¹è¿›ï¼š
1. **æ­£åˆ™è¡¨è¾¾å¼ä¼˜åŒ–**: æ”¯æŒWindowså’ŒUnixè·¯å¾„æ ¼å¼
2. **æ™ºèƒ½ç­–ç•¥**: å¤šå±‚æ¬¡çš„å‚æ•°å¤„ç†ç­–ç•¥
3. **é”™è¯¯æ¢å¤**: è‡ªåŠ¨ä»æ–‡ä»¶ç®¡ç†å™¨è·å–ä»£ç å†…å®¹
4. **é…ç½®éªŒè¯**: å®Œæ•´çš„å®éªŒé…ç½®æ£€æŸ¥
5. **æµ‹è¯•éªŒè¯**: ä¸“é—¨çš„æ”¹è¿›æ•ˆæœæµ‹è¯•

## ğŸ“Š é¢„æœŸæ”¹è¿›æ•ˆæœ

åŸºäºè¿™äº›æ”¹è¿›ï¼ŒTDDæ¡†æ¶åº”è¯¥èƒ½å¤Ÿï¼š

1. **è§£å†³Windowså…¼å®¹æ€§**: å®Œå…¨æ”¯æŒWindowsè·¯å¾„æ ¼å¼
2. **æ™ºèƒ½å‚æ•°å¤„ç†**: è‡ªåŠ¨å¤„ç†å„ç§å‚æ•°æ ¼å¼é—®é¢˜
3. **å¯é çš„ä»¿çœŸéªŒè¯**: ç¡®ä¿ä»¿çœŸèƒ½å¤ŸæˆåŠŸè¿è¡Œ
4. **å®Œæ•´çš„TDDæµç¨‹**: çœŸæ­£çš„æµ‹è¯•é©±åŠ¨å¼€å‘å¾ªç¯
5. **è¯¦ç»†çš„é”™è¯¯åˆ†æ**: æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯å’Œè§£å†³å»ºè®®

è¿™äº›æ”¹è¿›ç›´æ¥é’ˆå¯¹ `alu_test_utf8_fixed.txt` ä¸­å‘ç°çš„å…·ä½“é—®é¢˜ï¼Œåº”è¯¥èƒ½å¤Ÿæ˜¾è‘—æé«˜TDDæ¡†æ¶çš„å¯é æ€§å’ŒæˆåŠŸç‡ã€‚

## ğŸš€ æœ€æ–°é‡å¤§æ”¹è¿›ï¼šé”™è¯¯ä¿¡æ¯ä¼ é€’æœºåˆ¶

### æ ¸å¿ƒé—®é¢˜è¯†åˆ«

åŸºäºå¯¹ `alu_test_utf8_fixed.txt` çš„æ·±å…¥åˆ†æï¼Œå‘ç°äº†ä¸€ä¸ªå…³é”®é—®é¢˜ï¼š

**ä»¿çœŸå¤±è´¥æ—¶ï¼Œé”™è¯¯ä¿¡æ¯æ²¡æœ‰è¢«æ­£ç¡®ä¼ é€’ç»™æ™ºèƒ½ä½“ï¼Œå¯¼è‡´æ— æ³•è¿›è¡Œä»£ç ä¿®å¤**

å…·ä½“è¡¨ç°ï¼š
- ä»¿çœŸç¼–è¯‘å¤±è´¥ï¼š`result is not a valid l-value in tb_alu_32bit.uut`
- æ™ºèƒ½ä½“æ²¡æœ‰è·å¾—é”™è¯¯ä¿¡æ¯ï¼Œæ— æ³•è¿›è¡Œä¿®å¤
- å®éªŒç›´æ¥ç»“æŸï¼Œæ²¡æœ‰çœŸæ­£çš„TDDå¾ªç¯

### è§£å†³æ–¹æ¡ˆï¼šå®Œæ•´çš„é”™è¯¯ä¿¡æ¯ä¼ é€’æœºåˆ¶

#### 1. é”™è¯¯ä¿¡æ¯è®°å½•ç³»ç»Ÿ

åœ¨ `_force_run_simulation` æ–¹æ³•ä¸­æ·»åŠ äº†é”™è¯¯ä¿¡æ¯è®°å½•ï¼š

```python
# ğŸ¯ å…³é”®æ”¹è¿›ï¼šå¦‚æœä»¿çœŸå¤±è´¥ï¼Œç«‹å³å°†é”™è¯¯ä¿¡æ¯æ·»åŠ åˆ°ä¸Šä¸‹æ–‡ä¸­
if not result.get("success", False):
    self.logger.info("ğŸ”§ ä»¿çœŸå¤±è´¥ï¼Œå°†é”™è¯¯ä¿¡æ¯æ·»åŠ åˆ°ä¸Šä¸‹æ–‡")
    
    # å°†é”™è¯¯ä¿¡æ¯æ·»åŠ åˆ°å¢å¼ºåˆ†æä¸­
    if "simulation_errors" not in enhanced_analysis:
        enhanced_analysis["simulation_errors"] = []
    
    error_info = {
        "iteration": iteration,
        "error": result.get("error", "æœªçŸ¥é”™è¯¯"),
        "compilation_output": result.get("compilation_output", ""),
        "command": result.get("command", ""),
        "stage": result.get("stage", "unknown"),
        "return_code": result.get("return_code", -1),
        "timestamp": time.time()
    }
    
    enhanced_analysis["simulation_errors"].append(error_info)
```

#### 2. é”™è¯¯ä¿¡æ¯ä¼ é€’åˆ°è®¾è®¡ä»»åŠ¡

åœ¨ `_build_design_task` æ–¹æ³•ä¸­æ·»åŠ äº†é”™è¯¯ä¸Šä¸‹æ–‡ä¼ é€’ï¼š

```python
# ğŸ¯ å…³é”®æ”¹è¿›ï¼šæ·»åŠ ä»¿çœŸé”™è¯¯ä¿¡æ¯åˆ°è®¾è®¡ä»»åŠ¡ä¸­
simulation_errors = enhanced_analysis.get("simulation_errors", [])
if simulation_errors:
    # è·å–æœ€è¿‘çš„ä»¿çœŸé”™è¯¯
    latest_error = simulation_errors[-1]
    error_details = latest_error.get("error", "")
    compilation_output = latest_error.get("compilation_output", "")
    
    improvement_context = f"""
ğŸ”§ **åŸºäºç¬¬{iteration-1}æ¬¡è¿­ä»£çš„ä»¿çœŸé”™è¯¯è¿›è¡Œè®¾è®¡ä¿®å¤**

**ä»¿çœŸå¤±è´¥è¯¦æƒ…**:
{error_details}

**ç¼–è¯‘è¾“å‡º**:
{compilation_output}

**ğŸ¯ å¿…é¡»ä¿®å¤çš„é—®é¢˜**:
1. ä¿®å¤æ‰€æœ‰ç¼–è¯‘é”™è¯¯
2. ç¡®ä¿ç«¯å£å£°æ˜æ­£ç¡®
3. æ£€æŸ¥ä¿¡å·ç±»å‹åŒ¹é…
4. éªŒè¯æ¨¡å—æ¥å£è§„èŒƒ
5. ç¡®ä¿ä»£ç è¯­æ³•æ­£ç¡®

**ä¿®å¤è¦æ±‚**:
- å¿…é¡»ä½¿ç”¨ generate_verilog_code å·¥å…·é‡æ–°ç”Ÿæˆä»£ç 
- å¿…é¡»ä¿å­˜ä¿®å¤åçš„ä»£ç æ–‡ä»¶
- å¿…é¡»ç¡®ä¿ä»£ç èƒ½å¤Ÿé€šè¿‡ç¼–è¯‘
- å¿…é¡»ä¿æŒåŸæœ‰åŠŸèƒ½å®Œæ•´æ€§

è¯·æ ¹æ®ä»¥ä¸Šé”™è¯¯ä¿¡æ¯ä¿®æ­£è®¾è®¡ï¼Œç¡®ä¿æ‰€æœ‰é—®é¢˜å¾—åˆ°è§£å†³ã€‚
"""
```

#### 3. æ”¹è¿›çš„è¿­ä»£æ§åˆ¶é€»è¾‘

åœ¨ `_execute_single_tdd_iteration` ä¸­æ”¹è¿›äº†ç»§ç»­æ¡ä»¶ï¼š

```python
# 4. å†³å®šæ˜¯å¦ç»§ç»­ - æ”¹è¿›é€»è¾‘
# ğŸ¯ å…³é”®æ”¹è¿›ï¼šä¸ä»…æ£€æŸ¥æµ‹è¯•é€šè¿‡ï¼Œè¿˜è¦æ£€æŸ¥æ˜¯å¦éœ€è¦ä¿®å¤
needs_fix = test_result.get("needs_fix", False)
all_tests_passed = test_result.get("all_tests_passed", False)

# å¦‚æœæµ‹è¯•å¤±è´¥æˆ–éœ€è¦ä¿®å¤ï¼Œç»§ç»­è¿­ä»£
should_continue = not all_tests_passed or needs_fix

# å¦‚æœæœ‰ä»¿çœŸé”™è¯¯ï¼Œæ·»åŠ åˆ°ä¸Šä¸‹æ–‡ä¸­
if test_result.get("simulation_result") and not test_result["simulation_result"].get("success", False):
    if "simulation_errors" not in enhanced_analysis:
        enhanced_analysis["simulation_errors"] = []
    
    error_info = {
        "iteration": iteration,
        "error": test_result["simulation_result"].get("error", "æœªçŸ¥é”™è¯¯"),
        "compilation_output": test_result["simulation_result"].get("compilation_output", ""),
        "command": test_result["simulation_result"].get("command", ""),
        "stage": test_result["simulation_result"].get("stage", "unknown"),
        "return_code": test_result["simulation_result"].get("return_code", -1),
        "timestamp": time.time()
    }
    
    enhanced_analysis["simulation_errors"].append(error_info)
```

#### 4. å¼ºåˆ¶é”™è¯¯åˆ†æå’Œä¿®å¤æµç¨‹

åœ¨ `_analyze_simulation_results` ä¸­æ·»åŠ äº†å¼ºåˆ¶é”™è¯¯åˆ†æï¼š

```python
# ğŸ¯ æ„å»ºåŒ…å«è¯¦ç»†é”™è¯¯ä¿¡æ¯çš„åˆ†æä»»åŠ¡
if not success:
    # ä»¿çœŸå¤±è´¥çš„æƒ…å†µ - æ·»åŠ è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
    error_details = simulation_result.get('error', 'æœªçŸ¥é”™è¯¯')
    compilation_output = simulation_result.get('compilation_output', '')
    command = simulation_result.get('command', '')
    stage = simulation_result.get('stage', 'unknown')
    
    analysis_task = f"""
ğŸ”§ **ä»¿çœŸå¤±è´¥åˆ†æä»»åŠ¡**

ä»¿çœŸçŠ¶æ€: å¤±è´¥
å¤±è´¥é˜¶æ®µ: {stage}
è¿”å›ç : {simulation_result.get('return_code', -1)}

**è¯¦ç»†é”™è¯¯ä¿¡æ¯**:
{error_details}

**ç¼–è¯‘è¾“å‡º**:
{compilation_output}

**ğŸ¯ å¼ºåˆ¶é”™è¯¯åˆ†æå’Œä¿®å¤æµç¨‹**:

ä½ å¿…é¡»æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ‰§è¡Œï¼š

**ç¬¬ä¸€æ­¥ï¼šå¿…é¡»åˆ†æé”™è¯¯**
```json
{{
    "tool_name": "analyze_test_failures",
    "parameters": {{
        "design_code": "æ¨¡å—ä»£ç ",
        "compilation_errors": "{error_details}",
        "simulation_errors": "{error_details}",
        "testbench_code": "æµ‹è¯•å°ä»£ç ",
        "iteration_number": {iteration}
    }}
}}
```

**ç¬¬äºŒæ­¥ï¼šæ ¹æ®åˆ†æç»“æœä¿®å¤ä»£ç **
- å¦‚æœåˆ†ææ˜¾ç¤ºæµ‹è¯•å°è¯­æ³•é”™è¯¯ï¼Œå¿…é¡»é‡æ–°ç”Ÿæˆæµ‹è¯•å°
- å¦‚æœåˆ†ææ˜¾ç¤ºè®¾è®¡ä»£ç é—®é¢˜ï¼Œå¿…é¡»ä¿®æ”¹è®¾è®¡ä»£ç 
- å¦‚æœåˆ†ææ˜¾ç¤ºé…ç½®é—®é¢˜ï¼Œå¿…é¡»è°ƒæ•´å‚æ•°

**ç¬¬ä¸‰æ­¥ï¼šéªŒè¯ä¿®å¤æ•ˆæœ**
- é‡æ–°è¿è¡Œä»¿çœŸéªŒè¯ä¿®å¤æ˜¯å¦æˆåŠŸ
- å¦‚æœä»æœ‰é—®é¢˜ï¼Œé‡å¤åˆ†æ-ä¿®å¤-éªŒè¯æµç¨‹

è¯·ç«‹å³åˆ†æé”™è¯¯å¹¶æä¾›å…·ä½“çš„ä¿®å¤æ–¹æ¡ˆã€‚
"""
```

### 5. æ”¹è¿›çš„æµ‹è¯•éªŒè¯

åˆ›å»ºäº† `test_error_context_fix.py` æ¥ä¸“é—¨æµ‹è¯•é”™è¯¯ä¿¡æ¯ä¼ é€’æœºåˆ¶ï¼š

```python
async def test_error_context_fix():
    """æµ‹è¯•é”™è¯¯ä¿¡æ¯ä¼ é€’æ”¹è¿›"""
    # åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•ï¼Œé¢„æœŸä¼šäº§ç”Ÿç¼–è¯‘é”™è¯¯
    # éªŒè¯é”™è¯¯ä¿¡æ¯æ˜¯å¦è¢«æ­£ç¡®è®°å½•å’Œä¼ é€’
    # æ£€æŸ¥æ˜¯å¦è¿›è¡Œäº†å¤šæ¬¡è¿­ä»£ï¼ˆé”™è¯¯ä¿®å¤ï¼‰
    # éªŒè¯æœ€ç»ˆæ˜¯å¦æˆåŠŸä¿®å¤
```

### ğŸ¯ é¢„æœŸæ”¹è¿›æ•ˆæœ

åŸºäºè¿™äº›é‡å¤§æ”¹è¿›ï¼ŒTDDæ¡†æ¶ç°åœ¨èƒ½å¤Ÿï¼š

1. **å®Œæ•´çš„é”™è¯¯ä¿¡æ¯ä¼ é€’**: ä»¿çœŸå¤±è´¥æ—¶ï¼Œé”™è¯¯ä¿¡æ¯è¢«å®Œæ•´è®°å½•å¹¶ä¼ é€’ç»™è®¾è®¡æ™ºèƒ½ä½“
2. **çœŸæ­£çš„TDDå¾ªç¯**: å½“é‡åˆ°ç¼–è¯‘é”™è¯¯æ—¶ï¼Œç³»ç»Ÿä¼šç»§ç»­è¿­ä»£è¿›è¡Œä¿®å¤
3. **æ™ºèƒ½é”™è¯¯åˆ†æ**: æä¾›è¯¦ç»†çš„é”™è¯¯åˆ†ææŒ‡å¯¼ï¼ŒåŒ…æ‹¬å…·ä½“çš„å·¥å…·è°ƒç”¨ç¤ºä¾‹
4. **è‡ªåŠ¨ä¿®å¤æµç¨‹**: æ™ºèƒ½ä½“èƒ½å¤ŸåŸºäºé”™è¯¯ä¿¡æ¯è‡ªåŠ¨è¿›è¡Œä»£ç ä¿®å¤
5. **å¯é çš„è¿­ä»£æ§åˆ¶**: æ”¹è¿›çš„è¿­ä»£é€»è¾‘ç¡®ä¿é”™è¯¯ä¿®å¤è¿‡ç¨‹ä¸ä¼šä¸­æ–­

è¿™äº›æ”¹è¿›è§£å†³äº† `alu_test_utf8_fixed.txt` ä¸­æœ€å…³é”®çš„é—®é¢˜ï¼š**ä»¿çœŸå¤±è´¥æ—¶ç¼ºä¹é”™è¯¯ä¿¡æ¯ä¼ é€’å’Œä¿®å¤æœºåˆ¶**ï¼Œç°åœ¨TDDæ¡†æ¶åº”è¯¥èƒ½å¤Ÿå®ç°çœŸæ­£çš„æµ‹è¯•é©±åŠ¨å¼€å‘å¾ªç¯ã€‚ 